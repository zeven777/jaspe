tinymce.util.XHR.on("beforeSend",function(t){t.xhr.setRequestHeader("X-Requested-With","Something")}),tinymce.PluginManager.add("youtube",function(t){function e(t){var e=/^(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?(?=.*v=((\w|-){11}))(?:\S+)?$/,a=/^http\:\/\/www\.youtube\.com\/embed\/(((\w|-){11}))(?:\S+)?$/;return t.match(e)?RegExp.$1:t.match(a)?RegExp.$1:!1}function a(t){var e=/^(?:https?:\/\/)?(?:www\.)?vimeo\.com\/(((\d+)))(?:\S+)?$/,a=/^https?\:\/\/player\.vimeo\.com\/video\/(((\d+)))(?:\S+)?$/;return t.match(e)?RegExp.$1:t.match(a)?RegExp.$1:!1}function i(t){var e=/^(?:https?:\/\/)?(?:www\.)?dailymotion\.com\/video\/(((\w)))(?:\S+)?$/,a=/^https?\:\/\/www\.dailymotion\.com\/embed\/video\/(((\w)))(?:\S+)?$/;return t.match(e)?RegExp.$1:t.match(a)?RegExp.$1:!1}function r(t){var e={src:t.video.image,width:320,height:"auto","class":"mce-object mce-object-iframe","data-mce-object":"iframe","data-mce-src":t.video.image,"data-mce-p-src":t.video.embed,"data-mce-p-class":"embed-responsive-item","data-mce-p-frameborder":"0","data-mce-p-data-media":t.video.server,"data-mce-p-data-aspect":t.data.aspect?t.data.aspect:"4by3","data-timestamp":(new Date).getTime()};return e}function d(t){var e=/(https?\:\/\/[^\"]+)/i;return t.match(e)?RegExp.$1:!1}function o(t,r){var o={ok:!1,video:{embed:""}};o.data=t.data;var c={type:"GET",url:"",jsonp:"callback",dataType:"jsonp",success:function(t){o.video.embed=d(t.html),o.video.image=d(t.thumbnail_url),o.ok=!0,r(o)}};switch(!0){case"string"==typeof a(t.data.url):c.url="https://vimeo.com/api/oembed.json?url="+t.data.url,o.video.server="vimeo";break;case"string"==typeof i(t.data.url):c.url="http://www.dailymotion.com/services/oembed?url="+t.data.url,o.video.server="dailymotion";break;case"string"==typeof e(t.data.url):return o.video.server="youtube",o.video.embed="http://www.youtube.com/embed/"+e(t.data.url),o.video.image="http://img.youtube.com/vi/"+e(t.data.url)+"/0.jpg",o.ok=!0,void r(o)}$.ajax(c)}function c(){var d=t.selection.getNode();t.windowManager.open({width:400,height:120,title:"Video (Youtube, Vimeo, Dailymotion)",body:[{type:"textbox",name:"url",label:"Url",value:d.getAttribute("data-mce-p-src")},{type:"listbox",name:"aspect",label:"Aspect",values:[{text:"4:3",value:"4by3"},{text:"16:9",value:"16by9"}],value:d.getAttribute("data-mce-p-data-aspect")}],onsubmit:function(c){return e(c.data.url)===!1&&a(c.data.url)===!1&&i(c.data.url)===!1?void alert("Invalid Url"):void o(c,function(e){if(e.ok){var a,i=r(e),o='img[data-mce-p-src="'+e.video.embed+'"][data-timestamp="'+i["data-timestamp"]+'"]',c=t.dom.createHTML("img",i);"IMG"!==d.tagName?(t.insertContent(c),a=t.dom.select(o)[0]):a=d,a.parentNode.setAttribute("data-mce-class","embed-responsive embed-responsive-"+e.data.aspect),a.parentNode.setAttribute("class","embed-responsive embed-responsive-"+e.data.aspect),"IMG"===d.tagName&&(a.setAttribute("data-mce-p-src",e.video.embed),a.setAttribute("data-mce-p-data-aspect",e.data.aspect),a.setAttribute("src",e.video.image))}})}})}t.addButton("youtube",{tooltip:"Insert/Edit Video",icon:"media",onclick:c,stateSelector:"img[data-mce-p-data-media]"}),t.addMenuItem("youtube",{text:"Insert/Edit Video",context:"insert",icon:"media",onclick:c,prependToContext:!0}),t.on("preInit",function(){var e=t.schema.getSpecialElements();tinymce.each("iframe".split(" "),function(t){e[t]=new RegExp("</"+t+"[^>]*>","gi")});var a=t.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(t){a[t]={}}),t.parser.addNodeFilter("iframe",function(e,a){for(var i,r,d,o,c,m,s,n=e.length;n--;)if(r=e[n],r.parent){for(d=new tinymce.html.Node("img",1),d.shortEnded=!0,m=r.attributes,i=m.length;i--;)o=m[i].name,c=m[i].value,"width"!==o&&"height"!==o&&"style"!==o&&(("data"==o||"src"==o)&&(c=t.convertURL(c,o)),d.attr("data-mce-p-"+o,c));s=r.firstChild&&r.firstChild.value,s&&(d.attr("data-mce-html",escape(s)),d.firstChild=null),d.attr({width:r.attr("width")||"320",height:r.attr("height")||"auto",style:r.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":a,"class":"mce-object mce-object-"+a}),r.replace(d)}}),t.serializer.addAttributeFilter("data-mce-object",function(t,e){for(var a,i,r,d,o,c,m,s=t.length;s--;)if(a=t[s],a.parent){for(m=a.attr(e),i=new tinymce.html.Node(m,1),"audio"!=m&&"script"!=m&&i.attr({width:a.attr("width"),height:a.attr("height")}),i.attr({style:a.attr("style")}),d=a.attributes,r=d.length;r--;){var n=d[r].name;0===n.indexOf("data-mce-p-")&&i.attr(n.substr(11),d[r].value)}"script"==m&&i.attr("type","text/javascript"),o=a.attr("data-mce-html"),o&&(c=new tinymce.html.Node("#text",3),c.raw=!0,c.value=sanitize(unescape(o)),i.append(c)),a.replace(i)}})}).on("init",function(t){var r,d=t.target.dom.select('img[data-mce-object="iframe"]');if(0===d.length)return!1;for(r=0;r<d.length;r++){var c=d[r].getAttribute("data-mce-p-src");if(a(c)||i(c)||e(c)){var m={data:{}};m.data.timestamp=(new Date).getTime(),d[r].setAttribute("data-timestamp",m.data.timestamp),m.data.url=d[r].getAttribute("data-mce-p-src"),m.data.aspect=d[r].getAttribute("data-mce-p-data-aspect"),o(m,function(e){if(e.ok){var a=t.target.dom.select('img[data-mce-p-src="'+e.video.embed+'"][data-timestamp="'+e.data.timestamp+'"]');a[0].setAttribute("src",e.video.image),a[0].setAttribute("width",320),a[0].setAttribute("height","auto"),a[0].setAttribute("data-mce-p-data-media",e.video.server),a[0].parentNode.setAttribute("data-mce-class","embed-responsive embed-responsive-"+e.data.aspect),a[0].parentNode.setAttribute("class","embed-responsive embed-responsive-"+e.data.aspect),a[0].removeAttribute("data-timestamp")}})}}}).on("ObjectSelected",function(t){var e=t.target.getAttribute("data-mce-p-data-media");("youtube"===e||"vimeo"===e||"dailymotion"===e)&&t.preventDefault()}).on("blur",function(t){var e=t.target.dom.select("p[class]");tinymce.each(e,function(t){var e=t.getAttribute("data-mce-class"),a=t.querySelectorAll(':scope > img[data-mce-object="iframe"]');t.removeAttribute("class"),e&&a.length>0?t.setAttribute("class",e):t.removeAttribute("data-mce-class")})})});